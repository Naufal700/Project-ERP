<nb-card>
  <nb-card-header>
    <h5 class="mb-0">{{ data ? "Edit" : "Tambah" }} Penawaran</h5>
  </nb-card-header>

  <nb-card-body>
    <!-- Pelanggan & Tanggal -->
    <div class="form-grid">
      <div class="form-group">
        <label>Pelanggan</label>
        <nb-select fullWidth [(selected)]="formData.id_pelanggan" placeholder="Pilih Pelanggan">
          <nb-option *ngFor="let p of pelangganList" [value]="p.id">
            {{ p.nama_pelanggan }}
          </nb-option>
        </nb-select>
      </div>

      <div class="form-group">
        <label>Tanggal</label>
        <input nbInput fullWidth type="date" [(ngModel)]="formData.tanggal" />
      </div>
    </div>

    <!-- Detail Produk -->
    <div class="detail-section mt-3">
      <h6>Detail Produk</h6>
      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
          <thead>
            <tr>
              <th>Produk</th>
              <th width="80">Qty</th>
              <th width="120">Harga</th>
              <th width="120">Subtotal</th>
              <th width="50"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of formData.details; let i = index">
              <td>
                <nb-select fullWidth [(selected)]="d.id_produk" (selectedChange)="onProductChange(i)">
                  <nb-option *ngFor="let prod of produkList" [value]="prod.id">
                    {{ prod.kode_produk }} - {{ prod.nama_produk }}
                  </nb-option>
                </nb-select>
              </td>
              <td>
                <input nbInput type="number" min="1" [(ngModel)]="d.qty" (ngModelChange)="updateSubtotal(i)" />
              </td>
              <td>
                <input nbInput type="number" min="0" [(ngModel)]="d.harga" (ngModelChange)="updateSubtotal(i)" />
              </td>
              <td class="text-end">{{ calculateSubtotal(d) | currency:'IDR' }}</td>
              <td class="text-center">
                <button nbButton ghost size="tiny" status="danger" (click)="removeDetail(i)">
                  <nb-icon icon="trash-2-outline"></nb-icon>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <button nbButton size="small" status="info" (click)="addDetail()">
        <nb-icon icon="plus-outline"></nb-icon> Tambah Produk
      </button>
    </div>

    <!-- Catatan -->
    <div class="form-group mt-3">
      <label>Catatan</label>
      <textarea nbInput fullWidth rows="2" [(ngModel)]="formData.catatan"></textarea>
    </div>

    <!-- Total -->
    <div class="total-section text-end mt-3">
      <span>Total:</span>
      <strong>{{ getTotal() | currency:'IDR' }}</strong>
    </div>
  </nb-card-body>

  <nb-card-footer class="footer-actions">
    <button nbButton status="basic" (click)="cancel()">Batal</button>
    <button nbButton status="primary" [disabled]="loading" (click)="save()" type="button">
      <nb-spinner *ngIf="loading" size="tiny"></nb-spinner>
      <span *ngIf="!loading">Simpan</span>
    </button>
  </nb-card-footer>



</nb-card>
