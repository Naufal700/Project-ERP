<nb-card>
  <nb-card-header class="d-flex justify-content-between align-items-center flex-wrap">
    <h4 class="title">Menu Pembayaran Penjualan Tunai</h4>
    <div class="d-flex action-buttons">
      <button nbButton status="warning" size="medium" (click)="loadInvoices()" [disabled]="loading">
        <nb-icon *ngIf="!loading" icon="refresh-outline"></nb-icon>
        <nb-spinner *ngIf="loading" size="tiny"></nb-spinner>
        <span *ngIf="!loading">Refresh</span>
        <span *ngIf="loading">Memuat...</span>
      </button>
    </div>
  </nb-card-header>

  <nb-card-body>
    <!-- Filter Section -->
    <div class="filter-section d-flex flex-wrap align-items-center mb-3 gap-2">
      <nb-form-field class="flex-grow-1">
        <nb-icon nbPrefix icon="search-outline"></nb-icon>
        <input nbInput placeholder="Cari nomor invoice..." [(ngModel)]="searchTerm" (ngModelChange)="applyFilter()" />
      </nb-form-field>

      <nb-form-field>
        <input nbInput placeholder="Dari Tanggal" [nbDatepicker]="fromDatePicker" [(ngModel)]="fromDate"
          (ngModelChange)="applyFilter()" />
        <nb-datepicker #fromDatePicker></nb-datepicker>
      </nb-form-field>

      <nb-form-field>
        <input nbInput placeholder="Sampai Tanggal" [nbDatepicker]="toDatePicker" [(ngModel)]="toDate"
          (ngModelChange)="applyFilter()" />
        <nb-datepicker #toDatePicker></nb-datepicker>
      </nb-form-field>
    </div>

    <!-- Table Section -->
    <div class="table-responsive">
      <table class="table table-hover table-bordered table-sm mb-0">
        <thead>
          <tr>
            <th style="width: 40px;">#</th>
            <th>Nomor Invoice</th>
            <th>Tanggal Invoice</th>
            <th *ngIf="showPaymentColumns">Tanggal Pembayaran</th>
            <th *ngIf="showPaymentColumns">Cara Bayar</th>
            <th>Total</th>
            <th>Total Bayar</th>
            <th>Status Bayar</th>
            <th class="text-center" style="width: 140px;">Aksi</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let inv of paginatedInvoices; let i = index">
            <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
            <td>
              <span class="invoice-link" (click)="openDetailDialog(inv)">{{ inv.nomor_invoice }}</span>
            </td>
            <td>{{ inv.tanggal | date: "dd/MM/yyyy" }}</td>

            <td *ngIf="showPaymentColumns">
              <ng-container *ngIf="pembayaranTunai[inv.id]?.length > 0; else belumBayar">
                {{ pembayaranTunai[inv.id][0]?.tanggal_bayar | date: "dd/MM/yyyy" }}
              </ng-container>
              <ng-template #belumBayar>-</ng-template>
            </td>

            <td *ngIf="showPaymentColumns">
              <ng-container *ngIf="pembayaranTunai[inv.id]?.length > 0; else belumCaraBayar">
                {{ pembayaranTunai[inv.id][0]?.cara_bayar?.nama || pembayaranTunai[inv.id][0]?.metode_bayar || "-" }}
              </ng-container>
              <ng-template #belumCaraBayar>-</ng-template>
            </td>

            <td>{{ inv.total | currency: "IDR":"symbol":"1.0-0" }}</td>

            <td>{{ getSudahDibayar(inv) | currency: "IDR":"symbol":"1.0-0" }}</td>

            <td>
              <span [ngClass]="{
                  'text-success': inv.status === 'lunas',
                  'text-warning': inv.status !== 'lunas'
                }">
                {{ inv.status === "lunas" ? "Lunas" : "Belum lunas" }}
              </span>
            </td>

            <td class="text-center">
              <button nbButton size="small" status="primary" shape="round" ghost (click)="openBayarDialog(inv)"
                [disabled]="inv.status === 'lunas'" nbTooltip="Bayar" aria-label="Bayar">
                <nb-icon icon="credit-card-outline"></nb-icon>
              </button>

              <button *ngFor="let bayar of pembayaranTunai[inv.id]" nbButton size="small" status="danger" shape="round"
                ghost (click)="cancelBayar(bayar, inv)" nbTooltip="Batalkan pembayaran" class="ml-1"
                aria-label="Batalkan pembayaran">
                <nb-icon icon="close-outline"></nb-icon>
              </button>

              <button *ngFor="let bayar of pembayaranTunai[inv.id]" nbButton size="small" status="info" shape="round"
                ghost (click)="cetakStruk(bayar)" nbTooltip="Cetak struk" class="ml-1" aria-label="Cetak struk">
                <nb-icon icon="printer-outline"></nb-icon>
              </button>
            </td>
          </tr>

          <tr *ngIf="paginatedInvoices.length === 0">
            <td colspan="9" class="text-center text-muted">Tidak ada data ditemukan.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-wrapper d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
      <nb-select size="small" [(selected)]="itemsPerPage" (selectedChange)="changeItemsPerPage($event)">
        <nb-option *ngFor="let size of [5,10,20,50]" [value]="size">{{ size }} baris</nb-option>
      </nb-select>

      <nav *ngIf="totalPages > 1" aria-label="Pagination Navigation">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link" (click)="changePage(currentPage - 1, $event)"
              aria-label="Previous Page">‹</button>
          </li>
          <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
            [class.active]="currentPage === i + 1">
            <button class="page-link" (click)="changePage(i + 1, $event)"
              [attr.aria-current]="currentPage === i + 1 ? 'page' : null">
              {{ i + 1 }}
            </button>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <button class="page-link" (click)="changePage(currentPage + 1, $event)" aria-label="Next Page">›</button>
          </li>
        </ul>
      </nav>
    </div>
  </nb-card-body>
</nb-card>
