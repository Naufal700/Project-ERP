<nb-card>
  <nb-card-header>
    <h4 class="title">Sales Order</h4>
  </nb-card-header>

  <nb-card-body>
    <!-- Custom Tabs -->
    <div class="tab-container">
      <ul class="custom-tabs">
        <li [class.active]="activeTab === 'sq'" (click)="activeTab = 'sq'">SO dari SQ</li>
        <li [class.active]="activeTab === 'manual'" (click)="activeTab = 'manual'">SO Manual</li>
      </ul>

      <!-- Tombol Buat SO Manual hanya muncul di tab manual -->
      <button *ngIf="activeTab === 'manual'" nbButton status="primary" size="medium" (click)="openCreateOrderDialog()">
        <nb-icon icon="plus-outline"></nb-icon>
        <span>Buat SO Manual</span>
      </button>
    </div>

    <!-- Konten Tab SQ -->
    <ng-container *ngIf="activeTab === 'sq'">
      <ng-container *ngTemplateOutlet="soTable; context: { source: 'sq' }"></ng-container>
    </ng-container>

    <!-- Konten Tab Manual -->
    <ng-container *ngIf="activeTab === 'manual'">
      <ng-container *ngTemplateOutlet="soTable; context: { source: 'manual' }"></ng-container>
    </ng-container>

    <!-- Template Reusable -->
    <ng-template #soTable let-source="source">
      <!-- Filter -->
      <div class="filter-section d-flex flex-wrap align-items-center mb-3 gap-2">
        <nb-form-field class="flex-grow-1">
          <nb-icon nbPrefix icon="search-outline"></nb-icon>
          <input nbInput placeholder="Cari SO atau pelanggan..." [(ngModel)]="searchTerm" />
        </nb-form-field>

        <nb-form-field>
          <input nbInput placeholder="Dari Tanggal" [nbDatepicker]="fromDatePicker" [(ngModel)]="fromDate" />
          <nb-datepicker #fromDatePicker></nb-datepicker>
        </nb-form-field>

        <nb-form-field>
          <input nbInput placeholder="Sampai Tanggal" [nbDatepicker]="toDatePicker" [(ngModel)]="toDate" />
          <nb-datepicker #toDatePicker></nb-datepicker>
        </nb-form-field>

        <nb-select size="small" placeholder="Filter Status" [(selected)]="filterStatus">
          <nb-option value="">Semua</nb-option>
          <nb-option value="draft">Draft</nb-option>
          <nb-option value="approved">Approved</nb-option>
        </nb-select>

        <button nbButton status="warning" size="medium" (click)="refreshData()" [disabled]="isRefreshing">
          <nb-icon *ngIf="!isRefreshing" icon="refresh-outline"></nb-icon>
          <nb-spinner *ngIf="isRefreshing" size="tiny"></nb-spinner>
          <span *ngIf="!isRefreshing">Refresh</span>
          <span *ngIf="isRefreshing">Memuat...</span>
        </button>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table class="table table-hover table-bordered table-sm">
          <thead>
            <tr>
              <th><input type="checkbox" [(ngModel)]="selectAll" (change)="toggleSelectAll()" /></th>
              <th>#</th>
              <th *ngIf="source === 'sq'">Nomor SQ</th>
              <th>Nomor SO</th>
              <th>Tanggal</th>
              <th>Pelanggan</th>
              <th>Total</th>
              <th>Status</th>
              <th>Approved By</th>
              <th class="text-center">Aksi</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let data of getFilteredOrders(source) 
                        | slice: (currentPage - 1) * itemsPerPage: currentPage * itemsPerPage;
                        let i = index">
              <td><input type="checkbox" [(ngModel)]="data.selected" (change)="updateSelectedOrders()" /></td>
              <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
              <td *ngIf="source === 'sq'">{{ data.nomor_quotation || '-' }}</td>
              <td>{{ data.nomor_order || '-' }}</td>
              <td>{{ data.tanggal | date: 'dd/MM/yyyy' }}</td>
              <td>{{ data.pelanggan?.nama_pelanggan || data.quotation?.pelanggan?.nama_pelanggan }}</td>
              <td>{{ getQuotationTotal(data.details) | currency: 'IDR' : 'symbol' : '1.0-0' }}</td>
              <td>
                <span [ngClass]="{
                  'text-primary': data.status === 'draft',
                  'text-success': data.status === 'approved',
                  'text-danger': data.status === 'rejected'
                }">{{ data.status | titlecase }}</span>
              </td>
              <td>{{ data.approved_by_user?.name || '-' }}</td>
              <td class="text-center">
                <div class="btn-group">
                  <button nbButton size="medium" status="success" ghost *ngIf="data.status === 'draft'"
                    (click)="openVerifyDialog([data])">
                    <nb-icon icon="checkmark-outline"></nb-icon>
                  </button>
                  <button nbButton size="medium" status="danger" ghost *ngIf="data.status === 'draft'"
                    (click)="rejectOrder(data.id)">
                    <nb-icon icon="close-outline"></nb-icon>
                  </button>
                  <button nbButton size="medium" status="warning" ghost *ngIf="data.status === 'approved'"
                    (click)="cancelOrder(data.id)">
                    <nb-icon icon="refresh-outline"></nb-icon>
                  </button>
                  <button nbButton size="medium" status="info" ghost *ngIf="data.status === 'approved'"
                    (click)="printPdf(data.id)">
                    <nb-icon icon="printer-outline"></nb-icon>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="getFilteredOrders(source).length === 0">
              <td [attr.colspan]="source === 'sq' ? 10 : 9" class="text-center text-muted">
                Tidak ada data ditemukan.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Bulk Verify -->
      <div *ngIf="selectedOrders.length > 0 && source === 'sq'" class="mt-3">
        <button nbButton status="success" size="medium" (click)="openVerifyDialog(selectedOrders)">
          Verifikasi Terpilih ({{ selectedOrders.length }})
        </button>
      </div>

      <!-- Pagination -->
      <div class="pagination-wrapper d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
        <nb-select size="small" [(selected)]="itemsPerPage">
          <nb-option *ngFor="let size of [5, 10, 20, 50]" [value]="size">{{ size }} baris</nb-option>
        </nb-select>
        <nav *ngIf="getPages(getFilteredOrders(source)).length > 1">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <button class="page-link" (click)="currentPage = currentPage - 1">‹</button>
            </li>
            <li class="page-item" *ngFor="let page of getPages(getFilteredOrders(source)); let i = index"
              [class.active]="currentPage === i + 1">
              <button class="page-link" (click)="currentPage = i + 1">{{ i + 1 }}</button>
            </li>
            <li class="page-item" [class.disabled]="currentPage === getPages(getFilteredOrders(source)).length">
              <button class="page-link" (click)="currentPage = currentPage + 1">›</button>
            </li>
          </ul>
        </nav>
      </div>
    </ng-template>
  </nb-card-body>
</nb-card>
