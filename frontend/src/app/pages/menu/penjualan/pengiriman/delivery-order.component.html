<nb-card>
  <nb-card-header class="d-flex justify-content-between align-items-center flex-wrap">
    <h4 class="title">Delivery Orders</h4>
    <div class="d-flex action-buttons">
      <button nbButton status="warning" size="medium" (click)="refreshDO()" [disabled]="isRefreshing">
        <nb-icon *ngIf="!isRefreshing" icon="refresh-outline"></nb-icon>
        <nb-spinner *ngIf="isRefreshing" size="tiny"></nb-spinner>
        <span *ngIf="!isRefreshing">Refresh</span>
        <span *ngIf="isRefreshing">Memuat...</span>
      </button>
    </div>
  </nb-card-header>

  <nb-card-body>
    <!-- Tabs -->
    <ul class="nav nav-tabs custom-tabs">
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'so'" (click)="activeTab = 'so'">
          SO Siap DO
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'do'" (click)="activeTab = 'do'">
          Daftar DO
        </a>
      </li>
    </ul>

    <div class="tab-content mt-3">
      <!-- Tab SO Siap DO -->
      <div *ngIf="activeTab === 'so'">
        <div class="filter-section d-flex flex-wrap align-items-center mb-3 gap-2">
          <nb-form-field class="flex-grow-1">
            <nb-icon nbPrefix icon="search-outline"></nb-icon>
            <input nbInput placeholder="Cari SO atau pelanggan..." [(ngModel)]="searchTermSO"
              (ngModelChange)="filterSalesOrdersForDO()" />
          </nb-form-field>
        </div>

        <div class="table-responsive">
          <table class="table table-hover table-bordered table-sm">
            <thead>
              <tr>
                <th>#</th>
                <th>Nomor SO</th>
                <th>Pelanggan</th>
                <th>Tanggal</th>
                <th>Total</th>
                <th class="text-center">Aksi</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let so of filteredSalesOrdersForDO; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ so.nomor_order }}</td>
                <td>{{ so.pelanggan?.nama_pelanggan }}</td>
                <td>{{ so.tanggal | date:'dd/MM/yyyy' }}</td>
                <td>{{ so.total | currency:'IDR':'symbol':'1.0-0' }}</td>
                <td class="text-center">
                  <button nbButton size="tiny" status="success" (click)="createDO(so)">
                    Buat DO
                  </button>
                </td>
              </tr>
              <tr *ngIf="!filteredSalesOrdersForDO.length">
                <td colspan="6" class="text-center text-muted">Tidak ada SO yang siap dibuat DO</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tab Daftar DO -->
      <div *ngIf="activeTab === 'do'">
        <!-- Filter -->
        <div class="filter-section d-flex flex-wrap align-items-center mb-3 gap-2">
          <nb-form-field class="flex-grow-1">
            <nb-icon nbPrefix icon="search-outline"></nb-icon>
            <input nbInput placeholder="Cari DO, SO, atau pelanggan..." [(ngModel)]="searchTerm"
              (ngModelChange)="getFilteredDOs()" />
          </nb-form-field>

          <nb-form-field>
            <input nbInput placeholder="Dari Tanggal" [nbDatepicker]="fromDatePicker" [(ngModel)]="fromDate"
              (ngModelChange)="getFilteredDOs()" />
            <nb-datepicker #fromDatePicker></nb-datepicker>
          </nb-form-field>

          <nb-form-field>
            <input nbInput placeholder="Sampai Tanggal" [nbDatepicker]="toDatePicker" [(ngModel)]="toDate"
              (ngModelChange)="getFilteredDOs()" />
            <nb-datepicker #toDatePicker></nb-datepicker>
          </nb-form-field>

          <nb-select size="small" placeholder="Filter Status" [(selected)]="filterStatus"
            (selectedChange)="getFilteredDOs()">
            <nb-option value="">Semua</nb-option>
            <nb-option value="draft">Draft</nb-option>
            <nb-option value="approved">Approved</nb-option>
            <nb-option value="shipped">Shipped</nb-option>
            <nb-option value="completed">Completed</nb-option>
            <nb-option value="cancelled">Cancelled</nb-option>
          </nb-select>
        </div>

        <div class="table-responsive">
          <table class="table table-hover table-bordered table-sm">
            <thead>
              <tr>
                <th><input type="checkbox" [(ngModel)]="selectAll" (change)="toggleSelectAll()" /></th>
                <th>#</th>
                <th>No DO</th>
                <th>Sales Order</th>
                <th>Pelanggan</th>
                <th>Status</th>
                <th>Tanggal</th>
                <th>Approved By</th>
                <th class="text-center">Aksi</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let data of getFilteredDOs() | slice: (currentPage - 1) * itemsPerPage: currentPage * itemsPerPage; let i = index">
                <td><input type="checkbox" [(ngModel)]="data.selected" (change)="updateSelectedDOs()" /></td>
                <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
                <td>{{ data.no_do }}</td>
                <td>{{ data.sales_order?.nomor_order || '-' }}</td>
                <td>{{ data.pelanggan?.nama_pelanggan }}</td>
                <td>
                  <span [ngClass]="{
                    'text-primary': data.status === 'draft',
                    'text-warning': data.status === 'approved',
                    'text-info': data.status === 'shipped',
                    'text-success': data.status === 'completed',
                    'text-danger': data.status === 'cancelled'
                  }">{{ data.status | titlecase }}</span>
                </td>
                <td>{{ data.tanggal | date:'dd/MM/yyyy' }}</td>
                <td>{{ data.approvedBy?.name || '-' }}</td>
                <td class="text-center">
                  <div class="btn-group">
                    <!-- Approve DO -->
                    <button nbButton size="medium" status="success" ghost *ngIf="data.status === 'draft'"
                      (click)="approveDO(data.id)">
                      <nb-icon icon="checkmark-outline"></nb-icon>
                    </button>

                    <!-- Cancel hanya untuk DO yang sudah approved -->
                    <button nbButton size="medium" status="danger" ghost *ngIf="data.status === 'approved'"
                      (click)="cancelDO(data.id)">
                      <nb-icon icon="close-outline"></nb-icon>
                    </button>

                    <!-- Detail DO -->
                    <button nbButton size="medium" status="info" ghost (click)="openDetailDialog(data.id)">
                      <nb-icon icon="eye-outline"></nb-icon>
                    </button>

                    <!-- Ship DO -->
                    <button nbButton size="medium" status="warning" ghost *ngIf="data.status === 'approved'"
                      (click)="shipDO(data.id)">
                      <nb-icon icon="car-outline"></nb-icon>
                    </button>
                  </div>

                </td>
              </tr>
              <tr *ngIf="getFilteredDOs().length === 0">
                <td colspan="9" class="text-center text-muted">Tidak ada data ditemukan.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-wrapper d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
          <nb-select size="small" [(selected)]="itemsPerPage" (selectedChange)="itemsPerPage = $event">
            <nb-option *ngFor="let size of [5, 10, 20, 50]" [value]="size">{{ size }} baris</nb-option>
          </nb-select>
          <nav *ngIf="getPages(getFilteredDOs()).length > 1">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <button class="page-link" (click)="currentPage = currentPage - 1">‹</button>
              </li>
              <li class="page-item" *ngFor="let page of getPages(getFilteredDOs()); let i = index"
                [class.active]="currentPage === i + 1">
                <button class="page-link" (click)="currentPage = i + 1">{{ i + 1 }}</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage === getPages(getFilteredDOs()).length">
                <button class="page-link" (click)="currentPage = currentPage + 1">›</button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </nb-card-body>
</nb-card>
