<nb-card>
  <nb-card-header>
    Piutang - Daftar Invoice
  </nb-card-header>

  <nb-card-body>
    <div class="filter-row" style="display:flex; gap:1rem; margin-bottom:1rem; align-items:center;">
      <!-- Filter Nama Pelanggan Dropdown -->
      <nb-select placeholder="Filter Nama Pelanggan" [(selected)]="selectedCustomerId"
        (selectedChange)="onFilterChange()">
        <nb-option *ngFor="let cust of customers" [value]="cust.id">{{ cust.nama_pelanggan }}</nb-option>
      </nb-select>

      <!-- Filter Tanggal Dari -->
      <input nbInput placeholder="Tanggal Dari" [nbDatepicker]="startPicker" [(ngModel)]="filterStartDate"
        (dateChange)="onFilterChange()" />
      <nb-datepicker #startPicker></nb-datepicker>

      <!-- Filter Tanggal Sampai -->
      <input nbInput placeholder="Tanggal Sampai" [nbDatepicker]="endPicker" [(ngModel)]="filterEndDate"
        (dateChange)="onFilterChange()" />
      <nb-datepicker #endPicker></nb-datepicker>

      <!-- Search by Nama Pelanggan Text (optional) -->
      <input nbInput placeholder="Cari nama pelanggan..." [(ngModel)]="searchTerm" (input)="onSearchChange()" />
    </div>

    <div style="display:flex; justify-content:flex-end; gap: 0.5rem; margin-bottom:1rem;">
      <!-- Tombol Verifikasi Terpilih, muncul jika lebih dari 1 dipilih -->
      <button nbButton status="primary" *ngIf="selectedInvoiceIds.length > 1" (click)="verifySelectedInvoices()">
        Verifikasi Terpilih
      </button>
    </div>

    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>
            <input type="checkbox" [checked]="areAllSelected()" (change)="toggleSelectAll($event.target.checked)" />
          </th>
          <th>Tanggal Invoice</th>
          <th>Tanggal Jatuh Tempo</th>
          <th>No Invoice</th>
          <th>Nama Pelanggan</th>
          <th>Total Tagihan</th>
          <th>Total Bayar</th>
          <th>Sisa Piutang</th>
          <th>Status Piutang</th>
          <th>No Collecting</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let invoice of filteredInvoices"
          [class.jatuh-tempo-segera]="isJatuhTempoSegera(invoice.tanggal_jatuh_tempo)">
          <td>
            <input type="checkbox" [checked]="selectedInvoiceIds.includes(invoice.id)"
              (change)="toggleInvoiceSelection(invoice.id, $event.target.checked)" />
          </td>
          <td>{{ invoice.tanggal | date:'dd MMM yyyy' }}</td>
          <td>{{ invoice.tanggal_jatuh_tempo | date:'dd MMM yyyy' }}</td>
          <td>{{ invoice.nomor_invoice }}</td>
          <td>{{ invoice.nama_pelanggan || invoice.pelanggan?.nama_pelanggan || '-' }}</td>
          <td>{{ invoice.total | currency:'IDR' }}</td>
          <td>{{ getTotalBayar(invoice) | currency:'IDR' }}</td>
          <td>{{ getSisaPiutang(invoice) | currency:'IDR' }}</td>
          <td>{{ getStatusLabel(invoice.status) }}</td>
          <td>{{ invoice.no_collecting || '-' }}</td>
          <td>
            <button nbButton size="small" status="success" shape="icon" (click)="approvePiutang(invoice)"
              [disabled]="invoice.status !== 'approved'" title="Approve">
              <nb-icon icon="checkmark-outline"></nb-icon>
            </button>

            <button nbButton size="small" status="danger" shape="icon" (click)="cancelPiutang(invoice)"
              [disabled]="invoice.status === 'draft' || invoice.status === 'cancelled'" title="Cancel">
              <nb-icon icon="close-outline"></nb-icon>
            </button>
          </td>
        </tr>
        <tr *ngIf="filteredInvoices.length === 0">
          <td colspan="11" class="text-center">Tidak ada data invoice.</td>
        </tr>
      </tbody>
    </table>
  </nb-card-body>
</nb-card>
