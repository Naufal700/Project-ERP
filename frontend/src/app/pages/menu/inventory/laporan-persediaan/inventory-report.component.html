<nb-card>
  <nb-card-header class="header-container">
    <h4 class="title">
      Laporan Persediaan
      <span *ngIf="laporan.length > 0" class="badge-metode">
        (Metode: {{ laporan[0].metode }})
      </span>
    </h4>

    <div class="actions-container">
      <!-- Pilihan filter -->
      <nb-select size="small" [(selected)]="filterType" (selectedChange)="onFilterTypeChange($event)">
        <nb-option value="month">Periode Bulan</nb-option>
        <nb-option value="range">Tanggal Range</nb-option>
      </nb-select>

      <!-- Filter bulan -->
      <input *ngIf="filterType === 'month'" nbInput type="month" [(ngModel)]="selectedMonth" (change)="loadReport()" />

      <!-- Filter range tanggal -->
      <div *ngIf="filterType === 'range'" class="date-range">
        <input nbInput type="date" [(ngModel)]="startDate" (change)="loadReport()" />
        <span class="separator">s/d</span>
        <input nbInput type="date" [(ngModel)]="endDate" (change)="loadReport()" />
      </div>

      <!-- Button Closing -->
      <!-- Button Closing -->
      <button nbButton status="danger" size="small" (click)="closingStock()" [disabled]="isClosed">
        <nb-icon icon="lock-outline"></nb-icon>
        <span class="ml-1">Closing</span>
      </button>

      <!-- Export -->
      <button nbButton status="success" size="small" (click)="exportReport()">
        <nb-icon icon="cloud-download-outline"></nb-icon>
        <span class="ml-1">Export</span>
      </button>

      <!-- Template -->
      <button nbButton status="info" size="small" (click)="downloadTemplate()">
        <nb-icon icon="cloud-download-outline"></nb-icon>
        <span class="ml-1">Template</span>
      </button>

      <!-- Import -->
      <button nbButton status="success" size="small" (click)="fileInput.click()">
        <nb-icon icon="cloud-upload-outline"></nb-icon>
        <span class="ml-1">Import</span>
      </button>
      <input type="file" #fileInput hidden accept=".xlsx, .xls" (change)="onImport($event)" />
    </div>
  </nb-card-header>

  <nb-card-body>
    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover table-sm">
        <thead>
          <tr>
            <th rowspan="2">Kode Produk</th>
            <th rowspan="2">Nama Produk</th>
            <th rowspan="2">Satuan</th>
            <th rowspan="2">Kategori</th>
            <th colspan="3">Saldo Awal</th>
            <th colspan="5">Penerimaan</th>
            <th colspan="5">Pengeluaran</th>
            <th colspan="3">Sisa Stok</th>
          </tr>
          <tr>
            <th>Qty</th>
            <th>Harga</th>
            <th>Total</th>
            <th>Qty</th>
            <th>Harga</th>
            <th>Total</th>
            <th>Retur Supplier</th>
            <th>Selisih SO</th>
            <th>Qty</th>
            <th>Harga</th>
            <th>Total</th>
            <th>Retur Pembeli</th>
            <th>Selisih SO</th>
            <th>Qty</th>
            <th>Harga</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of paginatedLaporan">
            <td>{{ row.kode_produk }}</td>
            <td>{{ row.nama_produk }}</td>
            <td>{{ row.satuan }}</td>
            <td>{{ row.kategori }}</td>
            <td>{{ row.saldo_awal.qty }}</td>
            <td>{{ row.saldo_awal.harga | currency:'IDR' }}</td>
            <td>{{ row.saldo_awal.total | currency:'IDR' }}</td>
            <td>{{ row.penerimaan.qty }}</td>
            <td>{{ row.penerimaan.harga | currency:'IDR' }}</td>
            <td>{{ row.penerimaan.total | currency:'IDR' }}</td>
            <td>{{ row.penerimaan.retur_supplier }}</td>
            <td>{{ row.penerimaan.selisih_so }}</td>
            <td>{{ row.pengeluaran.qty }}</td>
            <td>{{ row.pengeluaran.harga | currency:'IDR' }}</td>
            <td>{{ row.pengeluaran.total | currency:'IDR' }}</td>
            <td>{{ row.pengeluaran.retur_pembeli }}</td>
            <td>{{ row.pengeluaran.selisih_so }}</td>
            <td>{{ row.sisa_stok.qty }}</td>
            <td>{{ row.sisa_stok.harga | currency:'IDR' }}</td>
            <td>{{ row.sisa_stok.total | currency:'IDR' }}</td>
          </tr>
          <tr *ngIf="paginatedLaporan.length === 0">
            <td colspan="19" class="text-center text-muted">Tidak ada data ditemukan.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-wrapper">
      <nb-select size="small" [(selected)]="itemsPerPage" (selectedChange)="changeItemsPerPage($event)">
        <nb-option *ngFor="let size of [5, 10, 20, 50]" [value]="size">
          {{ size }} baris
        </nb-option>
      </nb-select>

      <nav *ngIf="totalPages > 1">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="changePage(currentPage - 1)">‹</a>
          </li>
          <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
            [class.active]="currentPage === i + 1">
            <a class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="changePage(currentPage + 1)">›</a>
          </li>
        </ul>
      </nav>
    </div>

    <div *ngIf="loading" class="loading">
      Memuat laporan persediaan...
    </div>
  </nb-card-body>

</nb-card>
